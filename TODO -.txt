
# review for vlad 2024-10-23
- [ ] MR-1747 - ui2/main - https://mailroute.myjetbrains.com/youtrack/issue/MR-1747/Billing-Plan-Management-changes-needed-because-of-upcoming-roles-release
	- [ ] Changing billing plans
		- [ ] customer -> change billing plan
		- [ ] if customer belongs to reseller, only reseller can change billing plans
		- [ ] When upgrading from legacy, don't offer basics
- [ ] MR-1755 - ui2/1755 - https://mailroute.myjetbrains.com/youtrack/issue/MR-1755/Roles-Move-a-user-to-a-new-role
	- [ ] Check out how you can move a user to a new role.  Does this feel intuitive?
- [ ] MR-1760 - ui2/1760 - https://mailroute.myjetbrains.com/youtrack/issue/MR-1760/Roles-displaying-info-based-on-permissions
	- [ ] Check out how things are greyed out when you don't have permissions for something
- [ ] MR-1762 - ui2/hosted-mail - https://mailroute.myjetbrains.com/youtrack/issue/MR-1762/Hosted-Mail-Billing-Plans
	- [ ] Check out how the plans all look with hosted email added


Accounts for testing:

Reseller: 111TEST_RESELLER
	Reseller admin:  reseller_admin@test.com   password - base global admin role
	Reseller admin: reseller_admin_plus@test.com password - base global admin role + Allow Block List Manager
	Customer: test_reseller_customer - belongs to test_reseller
		Customer admin: reseller_customer_admin@test.com password
		Customer admin limited: reseller_customer_admin_limited@test.com password
				abl viewer
				customer manager
				no access to
					billing
					customer branding
					customer contacts
					delivery
						
		
		Domains:

			resellercustomerdomainbasics.com
				email accounts:
					user@
			resellercustomerdomainenterprise.com
				email accounts:
					limited@
						ABL Manager - all other is viewer only
					 full@
			NOT DONE - resellercustomerdomainenterpriseus.com
				email accounts:
					limited@
					 full@
			NOT DONE - resellercustomerdomaincompliance.com
				email accounts:
					limited@
					 full@
				
Direct Customer
	Customer: test_direct_customer[[
	Customer admin: direct_customer_admin@test.com password
	Customer admin limited: direct_customer_admin_limited@test.com 
		Only role is "quarantine manager"
	Domains:
		directcustomerdomainlegacy.com
			email accounts:
				user@
		directcustomerdomainbasics.com
			email accounts:
				user@

		directcustomerdomainenterprise.com
			email accounts:
				nologin@ everything but login is selected
				limited@ - only abl manager
				 full@

		directcustomerdomainenterpriseus.com
			email accounts:
				limited@
				 full@
		NOT DONE - directcustomerdomaincompliance.com
			email accounts:
				limited@
				 full@



### create a ticket for ui2/main issues
- On dev.mailroute.net
	- User: reseller_admin@test.com    ( password is "password")
		- Member of the default "global admins" group
		- Cannot see reseller or customers.
	- User: [reseller_admin_plus@test.com ('password')
		- Created new admin group with default permissiosn and added WBList Manager permission
		- Can see reseller and customers

### 2024-10-28 create a ticket for ui2/main issues:

Change the wording for the plan names here:
	Basics -> MailRoute Basics Email Security
	Basics Hosted Mail -> MailRoute Basics Email Security + Hosted Mail
	etc....

![[Pasted image 20241028180952.png]]



- Basics is allowed to choose "On Premise/Hosted Exchange or Other"- they just don't get Active Directory/LDAP sync.  They should still be able to select this as their type, though.
- 
![[Pasted image 20241028181235.png]]

- When adding a user, I like the role field there - but let's have the default one pre-selected:
  
  ![[Pasted image 20241028183014.png]]
  

- Why can't the user's of this enterprise test account see the Forwarding settings when they are enabled for the user?
  
  ![[Pasted image 20241028182657.png]]
- the domain is on an enterprise plan, but I don't see forwarding listed as any option for the domain admin - https://dev.mailroute.net/user/fulluser@directcustomerenterprise.com/#/forwarding
![[Pasted image 20241028182837.png]]





### questions:







# feature_settings table
### plan:

- [ ]  add feature settings table
- [ ] migrate some of the settings - continuity, anti-spoofing, over to here.

# Hosted Mail Feature Launch Plan

## 1. Technical Preparation

### High Priority
- [ ] Further test of hook
- [ ] Move production data into new db structures and test hook - move sa_userconf stuff to new structure
	- [ ] on es01.lax in ~root - migrate_to_new_wblist_extended.py does whitelist/blacklist

- [x] Upgrade Stalwart
- [x] Reach out to Stalwart about capacity testing done/underway. Get stats
- [ ] Resolve distribution list handling with IMAP service (within Stalwart or use internal forwarding)
- [x] Reinstall stalwart configuration?  Seems like it broke with update to 0.94
- [x] stalwart - get webadmin working - do we need to dowload a new version manually?
- [x] stalwart - Put webadmin behind nginx  proxy - tls
- [ ] Adjust quota_mb to come for user, not just domain
- [ ] Adjust query stored procedures for new quota_mb

- [x] Document changes for UI for vlad....
- [ ] Move haproxy stuff to point to es01 cluster for imap, pop?

### Coordinate with vlad
- [ ] Add hosted flags to policy table
	- [ ] move temporary_hosted to use policy table
- [ ] New wblist methods
	- [ ] migrate?
		- [ ] Move from rid to domain_id and "email_account_id", add "additional_checks"
			- [ ] migrate amavisd_wblist to new table
				- [ ] convert rd to domain_id, email_account_id
				- [ ] additional_checks is NULL
			- [ ] migrate current sa-user-conf settings to new table:
				- [ ] need to validate what he does works with my code
		- [ ] UI design:
		- [ ] 

			
#### old
```

CREATE TABLE `amavisd_wblist` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `sid` int(11) NOT NULL,
  `wb` varchar(10) NOT NULL,
  `rid` varchar(36) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `amavisd_wblist_sid_75f0b5c807fb559c_uniq` (`sid`,`rid`),
  KEY `rid` (`rid`),
  CONSTRAINT `amavisd_wblist_sid_ae57ba21_fk_amavisd_mailaddr_id` FOREIGN KEY (`sid`) REFERENCES `amavisd_mailaddr` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=15864278 DEFAULT CHARSET=utf8

```


#### new

```
	
	CREATE TABLE `amavisd_wblist_extended` (
	  `id` int(11) NOT NULL AUTO_INCREMENT,
	  `sid` int(11) NOT NULL,
	  `wb` varchar(10) NOT NULL,
	  `domain_id` int(11) DEFAULT NULL,
	  `email_account_id` int(11) DEFAULT NULL,
	  `additional_checks` text DEFAULT NULL,
	  PRIMARY KEY (`id`),
	  UNIQUE KEY `amavisd_wblist_sid_75f0b5c807fb559c_uniq` (`email_account_id`,`domain_id`,`sid`, `wb`),
	  KEY `idx_domain_id` (`domain_id`),
	  KEY `idx_email_account_id` (`email_account_id`),
	  KEY `idx_email` (`email`)
	) ENGINE=InnoDB AUTO_INCREMENT=3080146 DEFAULT CHARSET=utf8
	
	
	 CREATE TABLE `filter_score_adjustment` (
	  `id` int(11) NOT NULL AUTO_INCREMENT,
	  `email_account_id` int(11) DEFAULT NULL,
	  `domain_id` int(11) DEFAULT NULL,
	  `adjustment_type` VARCHAR(255) NOT NULL,
	  `target` varchar(255) NOT NULL,
	  `new_score` decimal(5,2) DEFAULT NULL,
	  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
	  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	  PRIMARY KEY (`id`),
	  KEY `idx_email_account_id` (`email_account_id`),
	  KEY `idx_domain_id` (`domain_id`)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;
```


### Archiving Service
  - [ ]   figure this out

### Medium Priority
- [ ] Implement auto-configuration for Outlook, Thunderbird

### Low Priority
- [ ] Develop quota management for Hosted Mail
- [ ] - [ ] Determine storage calculations for Hosted Mail (Stalwart? FoundationDB?)


## Vlad Changes that need to be made
- [ ] Get rid of temporary hosted tables
	- [ ] Move stuff into policyd
	- [ ] dovecot on s01 and s02
		- [ ] /etc/dovecot/conf.d/checkpassword.sh
		- [ ] ./etc/dovecot/conf.d/dovecot-sql.conf.ext.j2
- [ ] Policy tables:
	- [ ] add 


## 2. User Interface and Documentation

### High Priority
- [ ] Create UI pages for hosted mail
- [ ] Include mobileconfig and related info on hosted mail pages
- [ ] Rewrite KB articles in SMTP Auth to cover hosted mail

## 3. Marketing and Communication

### High Priority
- [ ] Prepare press release
- [ ] Draft notification for resellers



## 4. Post-Launch Planning

### Medium Priority
- [ ] Plan migration of entries from old whitelist/blacklist to new system

## Open Questions
- How to handle distribution lists with IMAP service? Within Stalwart or use internal forwarding?
- Decision on retrofitting autoresponder or sa-userconf code
- Do we need to change the main SQL query in amavisd-mroute.sql.conf? The UUID - is it needed any longer?

## Notes
- Consider releasing Hosted Mail before new whitelist/blacklist functionality is complete
- Plan for migrating entries from old whitelist/blacklist to new system after launch



# Move anti_spoofing_enabled to policy, remove uuid when fully transitioned to the new wblist stuff

```

Simplify amavisd query - move anti_spoofing_enabled to policy, remove uuid, add support for feature_settings table

TEST THIS OUT SOME MORE

SELECT 
    p.*,
    NULL AS anti_spoofing_enabled,
    e.uuid AS id,
    'Y' AS local,
    e.id as email_account_id,
    la.domain_id,
    p.priority AS sortpriority,
    JSON_MERGE_PATCH(
        COALESCE(domain_fs.settings, '{}'),
        COALESCE(user_fs.settings, '{}')
    ) as settings
FROM amavisd_localpartalias la
    INNER JOIN amavisd_emailaccount e ON (e.id = la.email_account_id)
    INNER JOIN amavisd_policy p ON (e.policy_id = p.id)
    LEFT JOIN amavisd_domainalias da ON (la.domain_id = da.domain_id AND da.name = %d)
    LEFT JOIN amavisd_domain d ON (la.domain_id = d.id)
    LEFT JOIN feature_settings domain_fs ON 
        domain_fs.email_account_id IS NULL 
        AND domain_fs.domain_id = la.domain_id
    LEFT JOIN feature_settings user_fs ON 
        user_fs.email_account_id = e.id 
        AND user_fs.domain_id = la.domain_id
WHERE la.localpart IN (%l, %u)
    AND (
        (la.external_domain IS NULL AND da.id IS NOT NULL) OR
        (la.external_domain = %d)
    )

UNION ALL

SELECT 
    p.*,
    NULL AS anti_spoofing_enabled,
    d.uuid AS id,
    'Y' AS local,
    NULL AS email_account_id,
    da.domain_id,
    p.priority AS sortpriority,
    fs.settings
FROM amavisd_domainalias da
    INNER JOIN amavisd_domain d ON (da.domain_id = d.id)
    INNER JOIN amavisd_policy p ON (d.policy_id = p.id)
    INNER JOIN amavisd_customer c ON (d.customer_id = c.id)
    LEFT JOIN feature_settings fs ON 
        fs.email_account_id IS NULL 
        AND fs.domain_id = da.domain_id
WHERE da.name = %d

UNION ALL

SELECT 
    p.*,
    0 AS anti_spoofing_enabled,
    '00000000-0000-0000-0000-000000000000' AS id,
    'N' AS local,
    NULL AS email_account_id,
    NULL AS domain_id,
    0 AS sortpriority,
    '{}' as settings
FROM amavisd_policy p
WHERE id = 28301

ORDER BY sortpriority DESC;


```





# Updating dovecot to use amavisd_policy table instead of temporary_hosted:

We have to add a flag to amavisd_policy for hosted_mail_enabled or whatever, then we can update these queries:


#### /etc/dovecot/conf.d/checkpassword.sh

**OLD**

```
select password from auth_user u left join amavisd_emailaccount e on u.id=e.user_id left join amavisd_localpartalias la on e.id=la.email_account_id left join amavisd_domainalias d on la.domain_id=d.domain_id left join temporary_hosted h on d.domain_id=h.domain_id where la.localpart='$localpart' and (d.name = '$domain' OR la.external_domain = '$domain')  and (h.hosted=1 or h.continuity=1) LIMIT 1

```

test - with domain and localpart substituted:
```
select password from auth_user u left join amavisd_emailaccount e on u.id=e.user_id left join amavisd_localpartalias la on e.id=la.email_account_id left join amavisd_domainalias d on la.domain_id=d.domain_id left join temporary_hosted h on d.domain_id=h.domain_id where la.localpart='tj' and (d.name = 'terramar.net' OR la.external_domain = 'terramar.net')  and (h.hosted=1 or h.continuity=1) LIMIT 1

```

**NEW**







#### /etc/dovecot/conf.d/dovecot-sql.conf.ext

**OLD**

```
user_query = \
SELECT home, mail, userdb_import, quota_rule FROM\
  (SELECT \
  concat("/data/mailstorage/", \
      substring(d.name,1, 1), "/", substring(d.name,2, 1), "/", d.name, "/", \
      substring(e.localpart,1, 1), "/", e.localpart) as home, \
  concat("maildir:/data/mailstorage/", \
      substring(d.name,1, 1), "/", substring(d.name,2, 1), "/", d.name, "/", \
      substring(e.localpart,1, 1), "/", e.localpart, \
      "/mail:INDEX=/data/mailindices/", \
      substring(d.name,1, 1), "/", substring(d.name,2, 1), "/", d.name, "/", \
      substring(e.localpart,1, 1), "/", e.localpart, \
      ":LAYOUT=fs") as mail, \
  IF (h.continuity, \
       CONCAT( \
       'namespace/inbox/mailbox/inbox/autoexpunge=', h.cont_storage_days, "d\t",       \
       'namespace/inbox/mailbox/Drafts/autoexpunge=', h.cont_storage_days, "d\t",       \
       'namespace/inbox/mailbox/Quarantine/autoexpunge=', h.cont_storage_days, "d\t",   \
       'namespace/inbox/mailbox/Quarantine.Spam/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.BadHeaders/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.BannedFiles/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.Blocked/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.Virus/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Trash/autoexpunge=', h.cont_storage_days, "d\t",        \
       'namespace/inbox/mailbox/Sent/autoexpunge=', h.cont_storage_days, "d"), '')      \
as userdb_import,\
  IF (h.continuity, 'continuity', '') as acl_groups,\
        CONCAT('*:storage=', quota_mb, 'M') AS quota_rule \
  FROM auth_user u LEFT JOIN amavisd_emailaccount e ON u.id=e.user_id \
    LEFT JOIN amavisd_localpartalias la ON e.id=la.email_account_id \
    LEFT JOIN amavisd_domainalias da ON la.domain_id=da.domain_id  \
    LEFT JOIN amavisd_domain d ON la.domain_id=d.id  \
    LEFT JOIN temporary_hosted h ON da.domain_id=h.domain_id \
  WHERE (la.localpart='%n' OR la.localpart = substring_index('%n','-', 1) OR la.localpart = substring_index('%n','+', 1)  ) and (da.name = '%d' OR la.external_domain = '%d')  and (h.hosted=1 or h.continuity=1)) dt

```


test - with localpart and domain substitution

```
SELECT home, mail, userdb_import, quota_rule FROM\
  (SELECT \
  concat("/data/mailstorage/", \
      substring(d.name,1, 1), "/", substring(d.name,2, 1), "/", d.name, "/", \
      substring(e.localpart,1, 1), "/", e.localpart) as home, \
  concat("maildir:/data/mailstorage/", \
      substring(d.name,1, 1), "/", substring(d.name,2, 1), "/", d.name, "/", \
      substring(e.localpart,1, 1), "/", e.localpart, \
      "/mail:INDEX=/data/mailindices/", \
      substring(d.name,1, 1), "/", substring(d.name,2, 1), "/", d.name, "/", \
      substring(e.localpart,1, 1), "/", e.localpart, \
      ":LAYOUT=fs") as mail, \
  IF (h.continuity, \
       CONCAT( \
       'namespace/inbox/mailbox/inbox/autoexpunge=', h.cont_storage_days, "d\t",       \
       'namespace/inbox/mailbox/Drafts/autoexpunge=', h.cont_storage_days, "d\t",       \
       'namespace/inbox/mailbox/Quarantine/autoexpunge=', h.cont_storage_days, "d\t",   \
       'namespace/inbox/mailbox/Quarantine.Spam/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.BadHeaders/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.BannedFiles/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.Blocked/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Quarantine.Virus/autoexpunge=', h.cont_storage_days, "d\t", \
       'namespace/inbox/mailbox/Trash/autoexpunge=', h.cont_storage_days, "d\t",        \
       'namespace/inbox/mailbox/Sent/autoexpunge=', h.cont_storage_days, "d"), '')      \
as userdb_import,\
  IF (h.continuity, 'continuity', '') as acl_groups,\
        CONCAT('*:storage=', quota_mb, 'M') AS quota_rule \
  FROM auth_user u LEFT JOIN amavisd_emailaccount e ON u.id=e.user_id \
    LEFT JOIN amavisd_localpartalias la ON e.id=la.email_account_id \
    LEFT JOIN amavisd_domainalias da ON la.domain_id=da.domain_id  \
    LEFT JOIN amavisd_domain d ON la.domain_id=d.id  \
    LEFT JOIN temporary_hosted h ON da.domain_id=h.domain_id \
  WHERE (la.localpart='tj' OR la.localpart = substring_index('tj','-', 1) OR la.localpart = substring_index('tj','+', 1)  ) and (da.name = 'terramar.net' OR la.external_domain = 'terramar.net')  and (h.hosted=1 or h.continuity=1)) dt
  
```

**NEW**

```


```







# New Feature Ideas

- [ ] DLP rules (credit cards, ssns, etc) for inbound and outbound checks?
- [ ] replay email stream to server.  Ideas continuity storage and fan replay last X minutes/hours/days of email to server.  Should hate details already in elastic.  If continuity enabled, then email is in s3
- [ ]  enable some continuity for all customers by default.  Give opt out option on domain and/or user basis.  This would let us grab a recently delivered email to use for bates retraining or support. Needs to be secure, though.  Customer needs to know what’s being stored.  
- [ ] Speed bumps for links or downloads? Don’t allow download until x amount of time has passed for av engines to catch up 
- [ ] undeliver mail in o365 (or imap?) by removing it from inbox or moving it or something
- [ ] New possible results of a wblist match?  Currently, we just quarantine.  Could also:
	- Possible results:
	- Bounce
	- Quarantine
	- Hold for Review?
	- Address Alteration
	- View only on secure website?  (ie send recipient a notice, and they have to use a website to view it?  Could be used for sending "secure" email to outside
	- Notify recipient?
	- Add disclaimer?
	- BCC
	- Strip attachments and replace with links
- [ ] Group of admins who can review, release, reject held emails
- [ ] Should we add per-customer encryption?
- [ ] Extra warnings when people try to release emails that are
	- high scoring
	- dkim/dmarc fails
	- ?
- [ ] IMAP feature built into user app (web and phone), to allow users to view their email in our own client (we would have to be sure we build a GREAT email client).  We could also then create a Reported Spam folder on their IMAP server and read anything they put in there.
- [ ] Should TXL/Bulk email be displayed in a different qtn notification? Different section of the same qtn notification.
- [ ] info bar - has a "security score" of "ABCDEF" - ie, if it fails dkim, no tls, high score, it's an F.  Maybe admins can choose what levels users can recover?  Maybe admins can recover lower-scoring stuff too?
- [ ] maybe instead of info bar - info in header. 
- [ ] Write plugins for different email clients to display X-MailRoute-Info header?
- [ ] IMAP server to our S3 continuity?
- [ ] Consider moving Continuity to use Hosted Mail platform?
- [ ] Internal reports to help us find customers who may be leaving, need info - ie, new admins added, changes in billing, etc....
- [ ] route all unfiltered mail out through non-mailroute IP address space (ie ACM forwards).
- [ ] allow users to unsubscribe from txl and bulk mails from continuity listing
- [ ] Once we have the "user" app (web and mobile), consider showing log info of deliveries of legit messages in there, and allow users to "unsubscribe" from legit opt-in mailings....what else could we do there?
- [ ] using o365 api, let an admin remove a message from his user's emailboxes.  maybe from the maillog?  Could this be done with imap access???
- [ ] spam filter: option to send classified mail to  qtn  - 
	- [ ] score RCVD_IN_MR_SERVICE_BULK high
	- [ ] score RCVD_IN_MR_SERVICE_TXL high
	- [ ] block dsn - score ANY_BOUNCE_MESSAGE high
- [ ] show reports of users who release. Who got big increase in email.   Who whitelists the most. Make this for admin. But also for super users to see global changes. 
- [ ] periodic emailed reporting updates (monthly, annual)
- [ ] DNSSec or DANE for mailroute.net domain
	- [ ] DNSSec
		- [x] Move mailroute.net over to hover
		- [x] Fix the nameservers - ns11.mailroute.net - ns13, ns41-ns43
		- [ ] Update the mailroute.net zone
		- [ ] Set up glue records.
		- [ ] Change the nameservers at hover
		- [ ] Set up signing for the domain.  
		- [ ] Make sure that all slaves are loading the signed zones.
		- [ ] Make sure that it's all correct via web-based tests.
- [ ] Automate signup emails:
	- @ time of signup: Welcome to MailRoute
	- @ 3 days: How can we help you?
	- @ 7 days: Did you know? Hints, plus stats
	- @ 10 days: trial is almost up.  We'll be sending you an invoice on x date, 
- [ ] Is there a way a user can specify that a recipient must be TLS encrypted?
	- [ ] Maybe assign a different category to the email?  CC_CLEAN, X ?
	- [ ] Or could it be routed out to a different outbound relay queue where TLS is set to "encrypt" and not "may"?


## Possible features based on modifying email bodies

### Inbound
- ### Infobars
	- Provide useful info to recipient based on message contents - warnings, report spam, etc...
- #### Link protection and scanning:
	 - Rewrite all URLs in the email to pass through your service first
	 - Scan links for malware, phishing, or other threats before allowing access
	 - Provide time-of-click protection by rescanning links when clicked
- #### Attachment sandboxing:
	 - Replace attachments with links to a sandboxed viewer
	 - Scan attachments for malware before allowing download
- 
### Outbound
- #### Data loss prevention (DLP):
	 - Scan outgoing emails for sensitive information (e.g., credit card numbers, social security numbers)
	 - Automatically redact or encrypt sensitive information
	 - Add warnings about potential data leaks
 - #### Customized disclaimers and signatures:
	 - Add or modify email signatures based on company policies or user roles
	 - Insert legal disclaimers or confidentiality notices
 - #### Time-based email expiration:
	- Implement a feature to make emails "self-destruct" after a certain time period
- #### Replace attachments with links to download file(s)
- 
### Inbound & Outbound
 - #### "Secure" email:
	 - Replace the message with one that directs users to sign in somewhere "securely" to read the actual message
- #### Email encryption:
	 - Automatically encrypt emails containing sensitive information
	 - Provide easy-to-use encryption options for end-users
- #### AI-powered content summarization:
	 - Provide AI-generated summaries of long emails
- #### Language translation:
	 - Offer automatic translation of email content

















	



AI: can Claude help develop prompt for doing SEO for marketing site? Cannot evaluate competitors to help?




Check the new MR_EMAILWL_DKIM rules to see how they're working out.  Does this work: MR_EMAILWL_DKIM_FAIL?  Can we raise the score up to a meaningful level?

Hosted Mail - Need to add support for distribution lists (what stalwart calls "mailing lists"). Need tables, UI for this.  Need to make sure it's kept separate from filtering - don't want to confuse people there.
	1.  Work out how to do "mailing lists" in stalwart
	
	Standard stalwart example:
		INSERT INTO emails (name, address, type) VALUES ('<ACCOUNT_NAME>', '<MAILING_LIST_ADDRESS>', 'list')

	#members = "SELECT member_of FROM group_members WHERE name = ?"
	#expand = "SELECT p.address FROM emails AS p JOIN emails AS l ON p.name = l.name WHERE p.type = 'primary' AND l.address = ? AND l.type = 'list' ORDER BY p.address LIMIT 50"


Hosted Mail - shared folders
	1.  Need to add users to groups
	2. Then what?  not seeing how to do this....


move redis from s02.lax.int.mailroute.net to 012.lax.int.mailroute.net (new redis is set up there - needed for decode urls, so move all the others over to this).  Need to check logstash when this is done.

Set up 002, 005 as new web app servers  for new ui2


MTA-STS - should we host the files for our customers? Then they just create the DNS rec


first time sender warning?


expiration strategy for new ES cluster
	amavisd - using forward dates, so expire anything after yesterday (?)
		Switched to using forward dates on 2023-07-14, so do this after 2023-10-14 or so
	others - expire anything more than X days old (90? 120?)
	(In the meantime, can expire anything older than about 90 days old)
	
	

- Migrate all servers to alma9
	- remaining:  010, s01, s02
	


Get p0f working again!  Requires some sort of transparent mode in haproxy. In themeantime, turn it off.  Then renable os_fingerprint in amavisd.conf once again


Change number of shards to 4, replica to 1 on new es cluster


		What's running on 010.lax?
			control panel.  Need to replicate over to miami anyways
			ansible for rhel 7
			root       963     1  0 Mar26 ?        00:00:40 /usr/sbin/smtpservercheck --bind
			redis      965     1  1 Mar26 ?        04:38:58 /usr/bin/redis-server 127.0.0.1:



			  


Put another instance of control panel in MIA and load-balance?

Possible: move redis to aws instance or some other hosted service? Same with memcached?  Or use a bare metal server somewhere else for this?


Can use multiple redis servers to store logging data for amavisd.  What about spamassassin bayes?  Can it do that?
Where else is it used.  Can't do redis-cluster since amavisd uses key space.  

	
idea: Move qa, dev databases to new, separate aws instances, for ease of snapshotting, backup/restore

Go to reserved instances for mroute_admin aws instances
	
	
Redis:
	Three uses we have:
		1. amavis logging cache - may want to use it for other services too
			Logstash then reads from these and saves to ES
			We can use multiple smaller redis servers for this....no need for it to all be in one consistent database
			So we can just run several, and have them round-robin or whatever, and logstash just reads from them all!
			Easy
			THis is really small, though - it's pretty much removed from the db the minute that logstash reads it.  Only builds up if L is down.
		2.  Penpals.  Less simple - needs to be a single database.
			maybe use master/slave/sentinel? But no sentinel support in amavisd redis code
			Either change that, or consider moving it to amavisd.mroute.custom.conf - maybe use ES queries instead?
				All that info is in ES - what would performance be like?
		3.  Spamassassin bayes.  Also needs 1 db.


	

	


				
				
				

!!! AWS: switch to reserved instances - once quarantine is shut down









New features
	NUMERIC_HTTP_ADDR or NORMAL_HTTP_TO_IP? url has numeric ip address
	WEIRD_PORT	url redirects to a strange port	Empty Message
		Messages with no subject, no content in the message body, and no attachments are marked as high confidence spam.

	<do a rule>  Contains html form elements (different elements)
	HTML_EMBEDS
	KAM_IFRAME
	SPF_FAIL
	web bug
	
		

	

ifplugin Mail::SpamAssassin::Plugin::BodyEval
  if can(Mail::SpamAssassin::Plugin::BodyEval::has_check_body_length)
    body            __MR_BODY_LENGTH_LT_2       eval:check_body_length('2')
        describe        __MR_BODY_LENGTH_LT_2        The length of the body of the email is less than 2 bytes
endif



Idea: Second Inbox
	What if we offered continuity+qtn as a sort of "second inbox".  Your mail is delivered to work.  Only important stuff is delivered to your work mail account.  Everything else is in continuity.  And in there, we do like gmail, and separate out the social, promotional, bulk, spam, etc.  You have your mail client for important stuff and you use our interface for the "second inbox".  Is this a variation of quietinbox?  Hmm....
	Maybe offer IMAP access to it?
		what's cost of providing both ES and imap storage of customer's email.  
	Is there a storage limit? Maybe we charge for additional storage? Maybe a time limit?
     Can you filter emails from an imap server?  Sorta. 
      What about an imap proxy?
    Or what about using api with o365 to do this?  Could we do our service then for gmail or o365 users individually?



	
  Currently, clean email delivered is 4.3TB per month.  That's workable  :)


  Another thought is to offer them access to their imap servers to give a unified view.  If the client is like gmail and really great to use, maybe people prefer it over a mail client, the way some gmail users prefer a browser to an imap server.   Could it be more secure somehow?  Vpn for example? What else could be done to make this attractive.   Could we then manipulate a users impa folder and put emails into specific directories and things like that? If they have a “spam” folder we check it for false negatives.  
    If we offer imap access to qtn we could do that too - if someone puts a message into a “spam” folder we can use it to train filters.  
    I think there’s a bigger idea in all this somewhere 
  


	


	
Huge idea: show how changes to spam score or filtering settings would have affected the last two weeks of traffic.  “If you raised the score, these are messages that would have been delivered”, or “if you turn in explicit filtering, here’s what would have been blocked”.  Use ES data!!!
	
	

postmaster
	*done* set up postmaster@* to point to virtualpostmaster@mailroute.net so we can keep track
	Need to put into T&C that we do this?
	
* done ACM sasl auth
	* different postfix instance?  Probably
	* different policyd limits for these users?  Probably
	Support articles

	
support mail.mailroute.us 


trial signup - force them to validate the user the same way that domain name ssl certs are verified?

Clear out MERCK stuff


BIG Idea - if we have IMAP access to user's accounts, we could filter into mailboxes, we could "pull" emails out of someone's inbox, etc....

!! idea - response messages from Abuse@mailroute.net - explains each one, gives hints on properly reporting, provides a list of unsubscribe links


 

Redis:
	Should we move to a hosted redis solution?  What will that cost
	Redis cluster?  Need to check amavisd, which uses lua.  See if keys could be set to use hash tags?  Or just simple failover from one redis instance to another?

What about a redis migration?  How big is redis? What will it cost?



paubox type of feature? If email relay isn't going over TLS, then redirect to secure site and send link. They charge $10/user/month for this
	possible add-on feature? on a per-user basis?  Most medical practices - only some users need it
	


Add a verification code phone number for admins, at least - so that we can verify who they are (ie send them a code and get them to read it to us over the phone)


Should we offer spam_tag3_level (ie blatant spam, between spammy and qtn)?
Should we offer spam_quarantine_cutoff_level
Should we offer *_admin


Setup autodetect of who is hosting and putting up more info/kb articles, etc


"Productivity Package"
	Time delayed delivery of email
		sorting of classes of mail
	Automatic unsubscribing of email
	Inbox pause based on day/time
	

Automate sending out regular reporting emails to admins.  Make it possible to add some custom stuff to each message for marketing/retention

Popups
	Ex: for admin - if continuity not enabled, popup to tell them about it



MOVE ALL Bounces to a single server, which isn't used for anything else.  So bounce messages stop affecting our other servers!


LAX - old 199.89.0.0
LAX - current 199.89.1.0
?LAX airport 199.89.2.0?
MIA - 199.89.3.0
LAS - 199.89.4.0



x - DONE Private network - set up DNS names for machines.
LAX: 172.16.145.192/26
	194 - 254
	netmask: 255.255.255.192
MIA: 172.18.9.0/26
	2 - 62
	netmask: 255.255.255.192
	
	
	
We have assigned the following ranges to your servers:

in LA:
172.16.145.192/26
You need to add a static route: 
ip route add 172.16.0.0/12 via 172.16.145.193

CIDR	172.16.145.192/26
Subnet	255.255.255.192
Gateway	172.16.145.193
Primary IP	172.16.145.194
Last Usable IP	172.16.145.254
Number of Usable IPs	61





in MIA:
172.18.9.0/26
You need to add a static route: 
ip route add 172.18.0.0/12 via 172.18.9.1


CIDR	172.18.9.0/26
Subnet	255.255.255.192
Gateway	172.18.9.1
Primary IP	172.18.9.2
Last Usable IP	172.18.9.62
Number of Usable IPs	61



		
		
-----------------



199.89.0.118 - being used by vlad/teamcity
gw37.lax01.mailroute.net (199.89.0.197) - same as 199.89.0.117
gw38.lax01.mailroute.net (199.89.0.198) - same as 199.89.0.118
gw21.lax01.mailroute.net (199.89.0.181) - same as 199.89.0.101
199.89.0.224 - same as 199.89.0.101
199.89.0.236 - same as 199.89.0.101
	

	



s01.lax.mailroute.net
	x dovecot, webmail for hosted/continuity
	x zfs directories in /data/mail*
	
	
s02.lax.mailroute.net
	x dsync mirror for dovecot
	x zfs directories in /data/mail*
	

LAX Datacenter



MYSQL DATABASE REDUNDANCY

	What is actually required?
		Postfix                   read
		amavis                    read
		Control Panel             read/write
		policyd/policydoutbound   read/write
		roundcube                 read/write

		quarantine                read/write - can't move until qtn storage is in imap

		
			
	
		
	Redis
		application - 2 in LAX, 2 in LAS
		logs - 2 in LAX, 2 in LAS
		

	Hardware requirements:
		At some point - add 2 more servers to each datacenter for MySQL.
		Consider adding extra ram to 2 more servers in each datacenter for Redis

	

give domains option to set TLS state (none, may, encrypt) for their inbound relay.  Use /etc/postfix/tls_relay.in (or a mysql map that retrieves the value from the amavisd_domain table) to determine how they want to do it.  tls_relay.in is in the format of "nexthop:port <value>", like "terramar.net.ms.mailroute.net:25	none"
   Options:
      none
      may ("Opportunistic")
      encrypt ("Force/Mandatory Encryption")
      ??? verify ("mandatory server certificate verification" - remote SMTP server certificate can be validated (not expired or revoked, and signed by a trusted Certification Authority)
	
	mysql query might be something like this:
		select concat(da.name, ".ms.mailroute.net:", deliveryport, "<tab>", d.tls_policy ) as result  
		  from amavisd_domainalias as da 
		  left join amavisd_domain as d on d.id=da.domain_id 
		  left join amavisd_mailserver as s on s.domain_id=d.id 
		  where da.name = '%d';



Get rid of older servers that draw all that power.
	gw01 (labeled Mr000) is an e3-1230 pizza box.  Move webserver off to load-balanced on other servers. Add it to the general processing group in lax02.
	
	gw11 - need to move log processing, mysql to somewhere else and decom
	gw17 - currently doing centrifuge and control panel.  Move to other machine(s) and decom.
	gw03  (labeled gw19) - using as general control server, primary log server. Move to other machines and decom.
	gw18 - running teamcity.  Move elsewhere and decom
	
	

memcached - run separately in each datacenter - only used for caching recipient accss verification info
	postfix supports only a single memcached per table right now (ick)
	move to using galera cluster with memcached plugin?


Redis
	Used for amavisd penpals and control panel sessions, amavisd logging
	Replication between master in one datacenter and slave in other
	Redis sentinel manages promoting master to slave
	amavis can list two, so if one is down, other will connect.  But...if primary comes back up, then will it keep connecting to promoted master?  Hmm...  It should connect to whichever is master!  Maybe use HA Proxy?  https://discuss.pivotal.io/hc/en-us/articles/205309388-How-to-setup-HAProxy-and-Redis-Sentinel-for-automatic-failover-between-Redis-Master-and-Slave-servers

		for lax
				Use mr007.lax02 as primary
			 		 mr007.ord01 as secondary?
			   

			 


Custom hook
	Better categorize email

		
		Category for Bulk Filtered (like "Spammy")
	
	
Banned file
	Block all attachments, then whitelist specific types?
			block everything:   qr'.\.[a-zA-Z0-9]*$' => 1,
			then allow:   [qr'^\.(jpeg|jpg|png|gif|bmp|tnef|doc|\.docx|xls|xlsx|ppt|pptx|pdf)$' => 0
			maybe extend the list of banned file type categories, so there's a "block" and "allow" version of each (maybe one in lowercase and the other uppercase, like 'D' and 'd' - check to see if amavisd is case-sensitive here!).  Then let people choose which to use.  Interface gives people option to "block all and allow exceptions" or "block these"  
			
			

Dev plan:
	Mobile optimization
	Info bar
	2b Diagnostics
	Alerting
	Access controls
	2a Improper-setup notifications
	Billing
	Full blown Archiving
	Hosted Mail
	


------------------DONE------------------
ElasticSearch Qtn:
	* TODO: change the names of the indices used by logstash so that they are based on future expiration date instead of current date.
	* Merge the ES qtn release


done Turn off logstash feed to 002/005/007/s02
done rebuild 002/005/007 on alma

* datacenter
	* rename dbq02 to 009.lax.mailroute.net
		has 2 extra 2 tb ssds installed!
			/dev/sda and /dev/sdc, I think...but not sure.
   * rename dbq01 to 008.lax.mailroute.net 
   	has big array installed

* Move to using private network between haproxy and the filtering servers

* Set up postfix-relaycontinuity on lax servers - part of alma 9 upgrade
*	amavisd.conf:
*		$clean_quarantine_method =  'smtp:127.0.0.1:10070';
*		$unchecked_quarantine_method =  'smtp:127.0.0.1:10070';


* Fix private network in lax on May 11.
* aruba switches - set up login, password, configure cross-connect/trunk
* Move private network on servers to new aruba switches
* setup es servers on 10gbit connections
 


PRIORITIES
	1.  * AWS migration - DONE
	2.  * Prototype so Vlad can get going on User 2.0
	3.  * ES/S3 delivery agent
	     * ES - putting body_text and headers into ES.  Done
	     * amavisd-custom hook - need to put mail_id into header or into the localpart of the RCPT TO address
	     	* Need to put domain in there too  and retention period
				* need to do postfix instance for managing this
			  * Can use amavisd mail_id for now....increase it to 16 characters (96 bits) to reduce chance of collisions.  Maybe eventually go to uuid v6?
			  * Put rentention data into JSON
			  * lifecycle based on s3 object tags - done in Amazon S3
			* Change ES index names to "amavisd-20220903" so we can also append -01 or whatever, and wildcards will still work
			* Change ES data to be stored in future-dated indexes 
			
			
		* - done.  Change Logstash to use "retention_max" to determine which index to use for storing data....instead of just using the date, use date + retention_max days in the future.
		  * finish the amavisd.mroute.custom.conf.x that's on 007.lax
		  * 	check to be sure that everything is being calculated properly
		*		add expiration_date_file and expiration_date_log to the index patterns!
	   *			add anything vlad is adding to the index patterns!
				
				
		Expire data when index is < TODAY
	